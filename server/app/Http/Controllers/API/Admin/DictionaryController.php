<?phpnamespace App\Http\Controllers\API\Admin;use App\Events\Dictionary\DictionaryUpdate;use App\Http\Controllers\Controller;use App\Http\Requests\StoreDictionary;use App\Http\Requests\StoreDictionaryUpdate;use App\Http\Resources\DictionaryResource;use App\Models\Core\Dictionary;use App\Models\Core\DictionaryLanguage;use Illuminate\Http\Request;use Illuminate\Support\Facades\Cache;class DictionaryController extends Controller{    /**     * Display a listing of the resource with server-side pagination & search.     */    public function index(Request $request)    {        $perPage = $request->input('per_page', 50);        $search  = $request->input('search');        $dateFrom = $request->input('date_from');        $dateTo   = $request->input('date_to');        $query = Dictionary::query()            ->orderBy('created_at', 'DESC')            ->with('info');        // Search by word or by translation value        if ($search) {            $query->where(function ($q) use ($search) {                $q->where('word', 'LIKE', "%{$search}%")                    ->orWhereHas('info', function ($sub) use ($search) {                        $sub->where('value', 'LIKE', "%{$search}%");                    });            });        }        // Date filters        if ($dateFrom) {            $query->whereDate('created_at', '>=', $dateFrom);        }        if ($dateTo) {            $query->whereDate('created_at', '<=', $dateTo);        }        return $query->paginate($perPage);    }    /**     * Get language IDs that already have a translation for a given word.     * Used by the frontend translate dialog.     */    public function languagesForWord(Request $request)    {        $word = $request->input('word');        if (!$word) {            return response()->json([]);        }        $languageIds = DictionaryLanguage::whereHas('dictionary', function ($q) use ($word) {            $q->where('word', $word);        })->pluck('language_id')->unique()->values();        return response()->json($languageIds);    }    /**     * Store a newly created resource in storage.     */    public function store(Request $request, StoreDictionary $storeDictionary)    {        Cache::tags(['translations'])->flush();        Cache::tags(['dictionaries'])->flush();        \DB::beginTransaction();        try {            // Check if this VALUE already exists for the given language            $issetWordLanguage = DictionaryLanguage::where('value', $request->value)                ->where('language_id', $request->language_id)                ->count();            if ($issetWordLanguage > 0) {                return response([                    'message' => 'ეს სიტყვა უკვე ნათარგმნია არჩეულ ენაზე',                ], 208)->header('Content-Type', 'application/json');            }            // Check if this ABBREVIATION already has a translation in the same language            if (!$request->id) {                $existingAbbr = Dictionary::where('word', $request->word)                    ->whereHas('info', function ($query) use ($request) {                        $query->where('language_id', $request->language_id);                    })                    ->first();                if ($existingAbbr) {                    return response([                        'message' => 'ეს აბრევიატურა უკვე არსებობს ამ ენაზე!',                    ], 208)->header('Content-Type', 'application/json');                }            }            if ($request->id) {                $word = Dictionary::findOrFail($request->id);            } else {                $word = Dictionary::create([                    'word' => $request->word,                ]);            }            $wordLanguage = DictionaryLanguage::create([                'dictionary_id' => $word->id,                'language_id'   => $request->language_id,                'value'         => $request->value,            ]);            event(new DictionaryUpdate());            \DB::commit();            return response([                'id'          => $word->id,                'word'        => $word->word,                'language_id' => $wordLanguage->language_id,                'value'       => $wordLanguage->value,                'created_at'  => $word->created_at,            ], 200)->header('Content-Type', 'application/json');        } catch (\Exception $e) {            \DB::rollBack();            return response(['result' => $e->getMessage()], 500)->header('Content-Type', 'application/json');        }    }    /**     * Update the specified resource in storage.     */    public function update(Request $request, StoreDictionaryUpdate $storeDictionaryUpdate, $id)    {        Cache::tags(['translations'])->flush();        Cache::tags(['dictionaries'])->flush();        $word = Dictionary::with(['info' => function ($query) use ($request) {            $query->where('language_id', $request->language_id ?: 1);        }])->findOrFail($id);        \DB::beginTransaction();        try {            $word->word = $request->word;            $word->save();            if ($word->info) {                $word->info->value = $request->value;                $word->info->save();            }            Cache::tags(['translations'])->flush();            Cache::tags(['dictionaries'])->flush();            event(new DictionaryUpdate());            \DB::commit();            return new DictionaryResource($word);        } catch (\Exception $e) {            \DB::rollBack();            return response(['result' => $e->getMessage()], 500)->header('Content-Type', 'application/json');        }    }    /**     * Remove the specified resource from storage.     */    public function destroy($id)    {        Cache::tags(['translations'])->flush();        Cache::tags(['dictionaries'])->flush();        Dictionary::destroy($id);        DictionaryLanguage::where('dictionary_id', $id)->delete();    }}