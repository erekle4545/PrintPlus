<?phpnamespace App\Http\Controllers\API\Admin;use App\Helpers\Core\Multitenant;use App\Http\Controllers\Controller;use App\Http\Resources\SliderResource;use App\Models\Core\Cover;use App\Models\Core\Slider;use App\Models\Core\SliderLanguage;use Illuminate\Http\Request;use Illuminate\Support\Facades\Cache;use Illuminate\Support\Facades\DB;class SliderController extends Controller{    /**     * Display a listing of the resource.     *     * @return \Illuminate\Http\Response     */    public function index(Request $request)    {        $sliders = Slider::query();        if ($request->keyword) {            $sliders->whereHas('info', function ($query) use ($request) {                $query->with('covers');                $query->where('language_id', $request->language_id);                $query->where('title', 'like', '%' . $request->keyword . '%');            })->with('info.covers');        } else {            $sliders->with(array('info' => function ($query) use ($request) {                $query->with('covers');                $query->where('language_id', $request->language_id);            }));        }        return new SliderResource($sliders->paginate(10));    }    /**     * Store a newly created resource in storage.     *     * @param  \Illuminate\Http\Request  $request     * @return \Illuminate\Http\Response     */    public function store(Request $request)    {        DB::beginTransaction();        try {            $slider = Slider::create([                'status'=>$request->status,                'slug'=>$request->slug,                'date'=>\Carbon\Carbon::parse(time()),            ]);            $sliderLanguage = SliderLanguage::create([                'slider_id'=>$slider->id,                'language_id'=>$request->language_id,                'title'=>$request->title,                'description' => $request->description,            ]);            if($request->cover_id) {                /**                 *  covers                 */                foreach ($request->cover_id as $key => $value) {                    Cover::Create([                        'files_id'       => $value,                        'cover_type'     => $request->cover_type[$key],                        'coverable_type' => Multitenant::getModel('SliderLanguage'),                        'coverable_id'   => $sliderLanguage->id,                    ]);                }            }            $sliderResData = [                'id'=>$slider->id,                'info'=>$sliderLanguage            ];            DB::commit();            Cache::tags('sliders')->flush();            return response($sliderResData, 200)->header('Content-Type', 'application/json');        }catch (\Exception $exception){            DB::rollBack();            return response(['result' => $exception->getMessage()], 500)->header('Content-Type', 'application/json');        }    }    /**     * Display the specified resource.     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function show(Request $request,$id)    {        $model = Multitenant::getModel('Slider');        try {            //Find page with id and language id            $slider= $model::with(['info' => function ($query) use ($request) {                $query->where('language_id', $request->language_id);            }, 'info.covers'])->findOrFail($id);            //if we can not find Category with id and language, select very first Category ignoring Language            if (is_null($slider->info)) {                $slider = $model::with(['info','info.covers'])->findOrFail($id);            }        } catch (Exception $e) {            return response(['result' => 'not found'], 404)->header('Content-Type', 'application/json');        }        return new SliderResource($slider);    }    /**     * Update the specified resource in storage.     * @param  \Illuminate\Http\Request  $request     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function update(Request $request, $id)    {        try {            //Find Page            $slider = Slider::with(['info' => function ($query) use ($request) {                $query->where('language_id', $request->language_id);            }, 'infos.covers'])->findOrFail($id);            $slider->status = $request->status;            $slider->slug = $request->slug;            $slider->date = \Carbon\Carbon::parse(time());            $slider->save();            /**             * Attache covers             */            if (!is_null($slider->info)) {                $coverModel = Multitenant::getModel('Cover');                $coverModel::where('coverable_type', Multitenant::getModel('SliderLanguage'))->where('coverable_id', $slider->info->id)->delete();            }            if ($request->cover_id) {                //Remove covers                if (!is_null($slider->info)) {                    foreach ($request->cover_id as $key => $value) {                        $coverModel::Create([                            'files_id'        => $value,                            'cover_type'     => $request->cover_type[$key],                            'coverable_type' => Multitenant::getModel('SliderLanguage'),                            'coverable_id'   => $slider->info->id,                        ]);                    }                }            }            //Update category language            if (!is_null($slider->info)) {                $slider->info->title = $request->title;                $slider->info->description = $request->description ?: " ";                $slider->info->save();                //sleep(10);                //event(new MenuChanged());                return new SliderResource($slider);            }else{                SliderLanguage::create([                    'slider_id'=>$slider->id,                    'language_id'=>$request->language_id,                    'title'=>$request->title,                    'description' => $request->description,                ]);            }            Cache::tags('sliders')->flush();        } catch (Exception $e) {            return response(['result' => 'not found'], 404)->header('Content-Type', 'application/json');        }    }    /**     * Remove the specified resource from storage.     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function destroy($id)    {        $slider = Slider::where('id', $id)->with('infos')->first();        if ($slider->infos->count() > 1) {            SliderLanguage::where(['slider_id' => $id, 'language_id' => $slider->language_id])->delete();            Slider::where('id', $id)->delete();        } else {            SliderLanguage::where(['slider_id' => $id])->delete();            Slider::where('id', $id)->delete();        }        Cache::tags('sliders')->flush();        return response(['result' => $slider], 200)->header('Content-Type', 'application/json');    }    public function sliderSide(Request $request){        $slider = Slider::with(['info' => function ($query) use ($request) {            $query->where('language_id',$request->language_id);        }])->limit(5)->orderBy('created_at','DESC')->get();        return new SliderResource($slider);    }}