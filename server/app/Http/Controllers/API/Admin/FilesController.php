<?phpnamespace App\Http\Controllers\API\Admin;USE DB;use App\Http\Controllers\Controller;use App\Http\Resources\FilesResource;use Illuminate\Support\Facades\Auth;use Illuminate\Support\Facades\File;use App\Models\Core\Files;use App\Http\Requests\StoreFilesRequest;use App\Models\Core\Folder;use Illuminate\Http\Request;use Illuminate\Http\UploadedFile;use Illuminate\Support\Facades\Log;use Intervention\Image\Facades\Image;use mysql_xdevapi\Exception;class FilesController extends Controller{    /**     * Display a listing of the resource.     * @return \Illuminate\Http\Response     */    public function index(Request $request)    {        $query = Files::with('user:id,name,email')            ->orderBy('created_at', 'DESC');        // Role-based filtering        if (!Auth::user()->hasRole('super_admin')) {            $query->where('user_id', $request->user()->id);        }        // Search by file name        if ($request->filled('search_name')) {            $query->where('name', 'LIKE', '%' . $request->search_name . '%');        }        // Search by user name        if ($request->filled('search_user')) {            $query->whereHas('user', function ($q) use ($request) {                $q->where('name', 'LIKE', '%' . $request->search_user . '%');            });        }        // Date range filter        if ($request->filled('date_from')) {            $query->whereDate('created_at', '>=', $request->date_from);        }        if ($request->filled('date_to')) {            $query->whereDate('created_at', '<=', $request->date_to);        }        // Extension filter        if ($request->extensions) {            $extMap = [                'image' => ['jpg', 'jpeg', 'png', 'webp', 'gif', 'svg'],                'video' => ['mp4', 'webm', 'avi', 'mov'],                'docs'  => ['pdf', 'doc', 'docx', 'xlsx', 'xls', 'csv'],            ];            $allowedExtensions = [];            foreach ((array) $request->extensions as $ext) {                if (isset($extMap[$ext])) {                    $allowedExtensions = array_merge($allowedExtensions, $extMap[$ext]);                }            }            if (!empty($allowedExtensions)) {                $query->whereIn('extension', $allowedExtensions);            }        }        // Sorting        $query->reorder(); // clear previous orderBy        switch ($request->sort_by) {            case 'oldest':                $query->orderBy('created_at', 'ASC');                break;            case 'name_asc':                $query->orderBy('name', 'ASC');                break;            case 'name_desc':                $query->orderBy('name', 'DESC');                break;            default: // newest                $query->orderBy('created_at', 'DESC');                break;        }        return FilesResource::collection($query->paginate(24));    }    /**     * @param Request $request     * @return \Illuminate\Http\Resources\Json\AnonymousResourceCollection     */    public function getCovers(Request $request)    {        $ids = explode(",", $request->id);         return FilesResource::collection(Files::whereIn('id',$ids)->orderBy('created_at','DESC')->get());    }    /**     * @param Request $request     * @param Folder $folder     * @return \Illuminate\Http\Resources\Json\AnonymousResourceCollection|never     */    public function getByFolder(Request $request,Folder $folder){        if(!Auth::user()->hasRole('super_admin') && $folder->user_id != $request->user()->id){            return abort(403,'Unauthorized');        }        $where = [            'folder_id' => $folder->id        ];        return FilesResource::collection(Files::where($where)->paginate());    }    /**     * @param StoreFilesRequest $request     * @return \Illuminate\Http\JsonResponse     */    public function resize(StoreFilesRequest $request)    {        $all = $request->all();        $data = [            'type' => Files::TYPE_RESIZE,            'data' => json_encode($all),            'user_id' => $request->user()->id        ];        if (isset($all['folder_id'])) {            $folder = Folder::find($all['folder_id']);            // TODO: Uncomment when ready            // if ($folder->user_id != $request->user()->id) {            //     return response()->json([            //         'success' => false,            //         'message' => 'Unauthorized'            //     ], 403);            // }            $data['folder_id'] = $all['folder_id'];        }        // Move image in public Where path        $wFolder = str_replace('%', '', $all['w']);        $hFolder = str_replace('%', '', isset($all['h']) ? $all['h'] : '');        $whName = isset($all['h']) ? $wFolder . "x" . $hFolder : $wFolder . "xhAuto";        // ✅ შეინახე ატვირთული ფაილების ID-ები        $uploadedFiles = [];        foreach($all['file'] as $file) {            if ($file instanceof UploadedFile) {                $extensionFolder = $file->getClientOriginalExtension();                if ($extensionFolder === 'jpg' || $extensionFolder === 'png' || $extensionFolder === 'jpeg') {                    $generateFolderName = 'images';                } elseif ($extensionFolder === 'mp4') {                    $generateFolderName = 'videos';                } elseif ($extensionFolder === 'pdf') {                    $generateFolderName = 'docs';                } else {                    $generateFolderName = 'files';                }                $dir = 'uploads/' . $generateFolderName . '/' . $folder->name . '/' . $whName . '/';            } else {                $generateFolderName = 'files';                $dir = 'uploads/' . $generateFolderName . '/' . $folder->name . '/' . $whName . '/';            }            $absolutePath = $dir;            if (!File::exists($absolutePath)) {                File::makeDirectory($absolutePath, 0755, true);            }            if ($file instanceof UploadedFile) {                $data['name'] = $file->getClientOriginalName();                $filename = pathinfo($data['name'], PATHINFO_FILENAME);                $extension = $file->getClientOriginalExtension();                $data['extension'] = $extension;                $originalPath = $absolutePath . $data['name'];                $file->move($absolutePath, $data['name']);                $data['path'] = $dir . $data['name'];            } else {                $data['name'] = pathinfo($file, PATHINFO_BASENAME);                $filename = pathinfo($file, PATHINFO_FILENAME);                $extension = pathinfo($file, PATHINFO_EXTENSION);                $data['extension'] = $extension;                $originalPath = $absolutePath . $data['name'];                copy($file, $originalPath);            }            $data['path'] = $dir . $data['name'];            $w = $all['w'];            $h = $all['h'] ?? false;            // Resize            if ($extension === 'jpg' || $extension === 'png' || $extension === 'jpeg') {                list($width, $height, $image) = $this->getWidthAndHeight($w, $h, $originalPath);                $resizedFilename = $filename . '-x-' . $width . '-resized.' . $extension;                $image->resize($width, $height)->save($absolutePath . $resizedFilename);            } else {                $resizedFilename = $filename . '.' . $extension;            }            $data['output_path'] = $dir . $resizedFilename;            $fileManipulation = Files::create($data);            // ✅ შეინახე ატვირთული ფაილის ინფორმაცია            $uploadedFiles[] = [                'id' => $fileManipulation->id,                'name' => $fileManipulation->name,                'path' => $fileManipulation->path,                'output_path' => $fileManipulation->output_path,                'url' => asset($fileManipulation->output_path),            ];        }        // ✅ დააბრუნე JSON response file ID-ებით        if (count($uploadedFiles) === 1) {            // ერთი ფაილი            return response()->json([                'success' => true,                'id' => $uploadedFiles[0]['id'],                'file_id' => $uploadedFiles[0]['id'],                'name' => $uploadedFiles[0]['name'],                'url' => $uploadedFiles[0]['url'],                'data' => $uploadedFiles[0]            ], 200);        }        // მრავალი ფაილი        return response()->json([            'success' => true,            'count' => count($uploadedFiles),            'files' => $uploadedFiles        ], 200);    }    /**     * @param StoreFilesRequest $request     * @return FilesResource     *///    public function resize(StoreFilesRequest $request)//    {//        $all = $request->all();////        $request->validate([////            'images' => 'required',////        ]);////        $all = $request->all();////        foreach($all['images'] as $image) {////            $image->move(public_path('files'),$image->getClientOriginalName());////            $data =[////                'name' => 'asd',////                'path' => '/storage/',////                'folder_id'=>1,////                'type'=>Files::TYPE_RESIZE,////                'data'=>json_encode($all),////                'user_id'=>$request->user()->id////            ];////            Files::create($data);////        }////        return response($all['images']);//////            $file = $all['file'];////            unset($all['file']);////            $data = [//                'type' => Files::TYPE_RESIZE,//                'data' => json_encode($all),//                'user_id' => $request->user()->id//            ];////            if (isset($all['folder_id'])) {////                // TODO//                $folder = Folder::find($all['folder_id']);////                if ($folder->user_id != $request->user()->id) {////                    return abort(403, 'Unauthorized');////                }//                $data['folder_id'] = $all['folder_id'];//            }////            // Move image in public Where path   Str::Random()//            $wFolder = str_replace('%', '', $all['w']);//            $hFolder = str_replace('%', '', isset($all['h']));//            $whName = isset($all['h']) ? $wFolder . "x" . $hFolder : $wFolder . "xhAuto";////        foreach($all['file'] as $file) {//            if ($file instanceof UploadedFile) {//                $extensionFolder = $file->getClientOriginalExtension();//                if ($extensionFolder === 'jpg' || $extensionFolder === 'png' || $extensionFolder === 'jpeg') {//                    $generateFolderName = 'images';//                } elseif ($extensionFolder === 'mp4') {//                    $generateFolderName = 'videos';//                } elseif ($extensionFolder === 'pdf') {//                    $generateFolderName = 'docs';//                } else {//                    $generateFolderName = 'files';//                }////                $dir = 'uploads/' . $generateFolderName . '/' . $folder->name . '/' . $whName . '/';//            } else {//                $generateFolderName = 'files';//                $dir = 'uploads/' . $generateFolderName . '/' . $folder->name . '/' . $whName . '/';//            }////            $absolutePath = $dir;//            if (!File::exists($absolutePath)) {//                File::makeDirectory($absolutePath, 0755, true);//            }//            // END Move image in public Where path////            if ($file instanceof UploadedFile) {//                $data['name'] = $file->getClientOriginalName();//                $filename = pathinfo($data['name'], PATHINFO_FILENAME);//                $extension = $file->getClientOriginalExtension();//                $data['extension'] = $extension;//                $originalPath = $absolutePath . $data['name'];//                $file->move($absolutePath, $data['name']);//                $data['path'] = $dir . $data['name']; //////            } else {//                $data['name'] = pathinfo($file, PATHINFO_BASENAME);//                $filename = pathinfo($file, PATHINFO_FILENAME);//                $extension = pathinfo($file, PATHINFO_EXTENSION);//                $data['extension'] = $extension;//                $originalPath = $absolutePath . $data['name'];//                copy($file, $originalPath);//            }////            $data['path'] = $dir . $data['name'];//            $w = $all['w'];//            $h = $all['h'] ?? false;////            // Resize//            if ($extension === 'jpg' || $extension === 'png' || $extension === 'jpeg') {//                list($width, $height, $image) = $this->getWidthAndHeight($w, $h, $originalPath);//                $resizedFilename = $filename . '-x-' . $width . '-resized.' . $extension;//                $image->resize($width, $height)->save($absolutePath . $resizedFilename);//            } else {//                $resizedFilename = $filename . '.' . $extension;//            }////            $data['output_path'] = $dir . $resizedFilename;////            $fileManipulation = Files::create($data);//              return new FilesResource($fileManipulation);//        }//////        return response('Success',200);//    }    /**     * @param  \App\Models\Core\Files  $files     * @return \Illuminate\Http\Response     */    public function show(Request $request,Files $files)    {        if (!Auth::user()->hasRole('super_admin') && $files->user_id != $request->user()->id) {            return abort(403, 'Unauthorized');        }        return new FilesResource($files);    }    /**     * Remove the specified resource from storage.     * @param  \App\Models\Core\Files  $files     * @return \Illuminate\Http\Response     */    public function destroy(Files $files,$image)    {        $data =  DB::table('files')->whereIn('id', [$image])->get();        foreach ($data as $row){            $path =  $row->path;            $output_path =  $row->output_path;            File::delete($path);            File::delete($output_path);        }        try {            $ids = explode(",", $image);            $files->destroy($ids);        }catch (Exception $e) {            return response(['result' => 'not found'], 404)->header('Content-Type', 'application/json');        }        return response($image,204);    }    /**     * @param Files $files     * @param $ids     * @return \Illuminate\Http\JsonResponse     */        public function deleteWeb($id)        {            try {                $file = Files::findOrFail($id);                if ($file->user_id != Auth::id()) {                    return response()->json([                        'success' => false,                        'message' => 'Unauthorized'                    ], 403);                }                if ($file->path && File::exists(public_path($file->path))) {                    File::delete(public_path($file->path));                }                if ($file->output_path && File::exists(public_path($file->output_path))) {                    File::delete(public_path($file->output_path));                }                $file->delete();                return response()->json([                    'success' => true,                    'message' => 'File deleted successfully'                ], 200);            } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {                return response()->json([                    'success' => false,                    'message' => 'File not found'                ], 404);            } catch (\Exception $e) {                Log::error('File deletion error:', [                    'id' => $id,                    'error' => $e->getMessage()                ]);                return response()->json([                    'success' => false,                    'message' => 'Server error',                    'error' => $e->getMessage()                ], 500);            }        }    /**     * @param $w     * @param $h     * @param string $originalPath     * @return array     */    protected function getWidthAndHeight($w, $h, string $originalPath)    {        $image =  Image::make($originalPath);        $originalWidth = $image->width();        $originalHeight = $image->height();        if(str_ends_with($w,'%')){            $ratioW = str_replace('%','',$w);            $ratioH = $h ? str_replace('%','',$h):$ratioW;            $newWidth = $originalWidth * $ratioW / 100;            $newHeight = $originalHeight * $ratioH / 100;        }else{            $newWidth = (float)$w;            $newHeight = $h?(float)$h:($originalHeight * $newWidth/$originalWidth);        }        return [$newWidth,$newHeight,$image];    }}