<?phpnamespace App\Http\Controllers\API\Admin;use App\Events\Menu\MenuChanged;use App\Helpers\Core\Multitenant;use App\Http\Controllers\Controller;use App\Http\Resources\CategoryResource;use App\Models\Core\Category;use App\Models\Core\CategoryLanguage;use App\Models\Core\Cover;use App\Models\Core\Menu;use App\Models\Core\MenuLanguage;use Illuminate\Http\Request;use Illuminate\Support\Facades\DB;use Illuminate\Support\Facades\Log;class CategoryController extends Controller{    /**     * Display a listing of the resource.     *     * @return \Illuminate\Http\Response     */    public function index(Request $request)    {        $category = Category::query();        if ($request->keyword) {            $category->whereHas('info', function ($query) use ($request) {                $query->with('covers');                $query->where('language_id', $request->language_id);                $query->where('title', 'like', '%' . $request->keyword . '%');            })->with('info.covers');        } else {            $category->with(array('info' => function ($query) use ($request) {                $query->with('covers');                $query->where('language_id', $request->language_id);            }));        }        if ($request->status) {            $category->where('status', $request->status);        }        $category->orderBy('created_at', 'desc');        return new CategoryResource($category->paginate(10));    }    /**     * Store a newly created resource in storage.     * @param  \Illuminate\Http\Request  $request     * @return \Illuminate\Http\Response     */    public function store(Request $request)    {        DB::beginTransaction();        Log::info($request);        try {            $category = Category::create([                'status'=>$request->status,                'page_id'=>$request->page_id,                'date'=>\Carbon\Carbon::parse(time()),            ]);            $categoryLanguage = CategoryLanguage::create([                'category_id'=>$category->id,                'language_id'=>$request->language_id,                'title'=>$request->title,                'slug'=>$request->slug,                'description' => $request->description,            ]);            if($request->cover_id) {                /**                 *  covers                 */                foreach ($request->cover_id as $key => $value) {                    Cover::Create([                        'files_id'       => $value,                        'cover_type'     => $request->cover_type[$key],                        'coverable_type' => Multitenant::getModel('CategoryLanguage'),                        'coverable_id'   => $categoryLanguage->id,                    ]);                }            }            $categoryResData = [                'id'=>$category->id,                'info'=>$categoryLanguage            ];            DB::commit();            if ($request->assign_page) {                $this->assignToMenu($request, $category->id);            }            return response($categoryResData, 200)->header('Content-Type', 'application/json');        }catch (\Exception $exception){            DB::rollBack();            return response(['result' => $exception->getMessage()], 500)->header('Content-Type', 'application/json');        }    }    /**     * Display the specified resource.     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function show(Request $request,$id)    {        $model = Multitenant::getModel('Category');        try {            //Find page with id and language id            $category = $model::with(['info' => function ($query) use ($request) {                $query->where('language_id', $request->language_id);            }, 'info.covers','page'])->findOrFail($id);            //if we can not find Category with id and language, select very first Category ignoring Language            if (is_null($category->info)) {                $category = $model::with(['info','info.covers'])->findOrFail($id);            }        } catch (Exception $e) {            return response(['result' => 'not found'], 404)->header('Content-Type', 'application/json');        }        return new CategoryResource($category);    }    public function assignToMenu($request, $category_id)    {        DB::beginTransaction();        try {            $menu = Menu::Create([                'active'    => 1,                'category_id'   => $category_id,                'type'      => Config('menu.positions.header.id'),//                'dropdown'  => Config('menu.dropdown.types.children.value'),//                'meta'      => [],            ]);            /**             * Collect Facebook og tags             *///            $og_tags['facebook'] = [//                'og' => [//                    'title'         => $request->fb_og_title,//                    'description'   => $request->fb_og_description,//                    'url'           => $request->fb_og_url,//                    'type'          => $request->fb_og_type,//                ]//            ];            $menu_lang = MenuLanguage::Create([                'menu_id'       => $menu->id,                'language_id'   => $request->language_id,                'title'         => $request->title,                'description'   => $request->description,                'slug'          => $request->slug,//                'meta'          => $og_tags,            ]);            if ($request->cover_id) {                /**                 * Attach covers                 */                $coverModel = Multitenant::getModel('Cover');                foreach ($request->cover_id as $key => $value) {                    $coverModel::Create([                        'files_id'        => $value,                        'coverable_type' => Multitenant::getModel('MenuLanguage'),                        'coverable_id'   => $menu_lang->id,                    ]);                }            }            DB::commit();            event(new MenuChanged());        } catch (\Exception $e) {            DB::rollBack();            return response(['result' => $e->getMessage()], 500)->header('Content-Type', 'application/json');        }    }    /**     * Update the specified resource in storage.     * @param  \Illuminate\Http\Request  $request     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function update(Request $request, $id)    {        try {            //Find Page            $category = Category::with(['info' => function ($query) use ($request) {                $query->where('language_id', $request->language_id);            }, 'infos.covers'])->findOrFail($id);            $category->status = $request->status;            $category->page_id = $request->page_id;            $category->date = \Carbon\Carbon::parse(time());            $category->save();            /**             * Attache covers             */            if ($request->cover_id) {                //Remove covers                if (!is_null($category->info)) {                    $coverModel = Multitenant::getModel('Cover');                    $coverModel::where('coverable_type', Multitenant::getModel('CategoryLanguage'))->where('coverable_id', $category->info->id)->delete();                }                foreach ($request->cover_id as $key => $value) {                    $coverModel::Create([                        'files_id'        => $value,                        'cover_type'     => $request->cover_type[$key],                        'coverable_type' => Multitenant::getModel('CategoryLanguage'),                        'coverable_id'   => $category->info->id,                    ]);                }            }            //Update category language            if (!is_null($category->info)) {                $category->info->title = $request->title;                $category->info->slug = $request->slug;                $category->info->description = $request->description ?: " ";                $category->info->save();                //sleep(10);                //event(new MenuChanged());                return new CategoryResource($category);            }else{                CategoryLanguage::create([                    'category_id'=>$category->id,                    'language_id'=>$request->language_id,                    'title'=>$request->title,                    'slug'=>$request->slug,                    'description' => $request->description,                ]);            }            if ($request->assign_page) {                $this->assignToMenu($request, $category->id);            }        } catch (Exception $e) {            return response(['result' => 'not found'], 404)->header('Content-Type', 'application/json');        }    }    /**     * Remove the specified resource from storage.     *     * @param  int  $id     * @return \Illuminate\Http\Response     */    public function destroy(Request $request,$id)    {        $category = Category::where('id', $id)->with('infos')->first();        if ($category->infos->count() > 1) {            CategoryLanguage::where(['category_id' => $id, 'language_id' => intval($request->language_id)])->delete();        } else {            Menu::where(['category_id' => $id])->delete();            CategoryLanguage::where(['category_id' => $id])->delete();            Category::where('id', $id)->delete();        }        return response(['result' => $category], 200)->header('Content-Type', 'application/json');    }    public function categorySide(Request $request){        $cat = Category::with(['info' => function ($query) use ($request) {            $query->where('language_id',$request->language_id);        }])->limit(5)->orderBy('created_at','DESC')->get();        return new CategoryResource($cat);    }}